<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grilla de Asignaciones Marechal</title>

  <!-- üßº Estilos institucionales -->
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/grilla.css">
  <link rel="stylesheet" href="css/asignacion.css">
  <link rel="stylesheet" href="css/acciones.css">
  <link rel="stylesheet" href="css/leyenda.css">
  <link rel="stylesheet" href="css/turnos.css">
  <link rel="stylesheet" href="css/modal.css">
  <link rel="stylesheet" href="css/formulario.css">
  <link rel="stylesheet" href="css/comentarios.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- üß† √çcono institucional -->
  <link rel="icon" href="./iconos/calendario.ico" type="image/x-icon">

  <!-- Estilos inline para alinear botones en una l√≠nea y posicionar logout a la derecha -->
  <style>
    #contenedor-botones {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: -10px 20px;
    }
    #botones-izquierda {
      display: flex;
      gap: 10px;
    }
    #contenedor-botones .tab-btn {
      padding: 8px 16px;
      font-size: 14px;
    }
    #contenedor-logout {
      display: none; /* Inicialmente oculto, se mostrar√° seg√∫n autenticaci√≥n */
    }
  </style>
</head>
<body>
  <!-- üü¢ Leyenda de entidades -->
  <div id="bloque-entidades"><strong>Colores por entidad:</strong>
    <div id="leyenda-colores">
      
      <div class="leyenda-row" id="leyenda-dinamica"></div>
    </div>

    <div class="acciones-celda" id="acciones-entidades">
      <button class="btn-agregar btn-entidad" id="btn-agregar-entidad">‚ûï</button>
      <button class="btn-eliminar btn-entidad" id="btn-eliminar-entidad">‚ùå</button>
    </div>
  </div>

  <!-- üü¢ Contenedor de botones (todos en una l√≠nea, logout a la derecha) -->
  <div id="contenedor-botones">
    <div id="botones-izquierda">
      <!-- Tabs de turno -->
      <button class="tab-btn active" data-turno="Matutino">Matutino</button>
      <button class="tab-btn" data-turno="Vespertino">Vespertino</button>
      <button class="tab-btn" data-turno="Nocturno">Nocturno</button>
      <!-- Botones visibles para todos los usuarios -->
      <button class="tab-btn" id="btn-al-mapa">Al Mapa</button>
      <button class="tab-btn" id="btn-todas-aulas">Todas las Aulas</button>
      <!-- Bot√≥n admin (visible solo para admins) -->
      <button class="tab-btn" id="btn-admin" style="display: none;">Panel Admin</button>
    </div>
    <!-- Bot√≥n logout (a la derecha, visible para usuarios logueados) -->
    <div id="contenedor-logout">
      <button class="tab-btn" id="btn-logout">Cerrar Sesi√≥n</button>
    </div>
  </div>

  <!-- üóìÔ∏è Filtro de fecha en desplegable -->
  <div id="bloque-filtro-fecha" class="bloque-desplegable">
    <button id="toggle-fecha" class="btn-desplegable">üìÖ Filtrar por fecha</button>
    <div id="contenedor-fecha" class="contenedor-oculto">
      <input type="date" id="selector-fecha" class="selector-fecha">
      <button id="btn-reset-fecha" class="btn-reset-fecha">üßπ Limpiar filtro</button>
    </div>
  </div>

  <!-- üîç Buscador de aulas -->
  <div id="bloque-buscador" class="bloque-desplegable">
    <label for="input-buscador"><strong>Buscar aula:</strong></label>
    <input type="text" id="input-buscador" class="input-buscador" placeholder="Ej: Proyector, Aula 5...">
  </div>

  <!-- üü° Comentario flotante -->
  <div id="comentario-global" class="comentario-flotante"></div>

  <!-- T√≠tulo con ID (para compatibilidad con grilla.render.js) -->
  <h2 id="titulo-grilla">Grilla de Asignaciones Marechal</h2>

  <!-- üü¢ Contenedor principal -->
  <div id="grilla-container">Cargando grilla...</div>

  <!-- Modal -->
  <div id="modal-formulario"></div>

  <!-- üß† Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="js/grilla.core.js"></script>
  <script type="module">
    import {
      cargarAsignacionesPorAula,
      cargarAsignacionesPorAulaTodosLosTurnos,
      actualizarGrilla,
      renderVistaGeneral
    } from './js/grilla.render.js';

    // Manejo de par√°metros URL
    const params = new URLSearchParams(window.location.search);
    const aulaId = params.get('aula_id');
    const origen = params.get('origen');
    window.aulaSeleccionada = aulaId || null;

    if (aulaId) {
      console.log('üß≠ Aula seleccionada:', aulaId, '| Origen:', origen);
      if (origen === 'mapa') {
        cargarAsignacionesPorAulaTodosLosTurnos(aulaId); // üß© render extendido
      } else {
        cargarAsignacionesPorAula(aulaId); // ‚úÖ comportamiento normal
      }
    }

    // Interceptar clicks de pesta√±as de turno
    document.querySelectorAll('.tab-btn[data-turno]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn[data-turno]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const turno = btn.dataset.turno;
        if (turno) {
          actualizarGrilla(turno); // ‚úÖ mantiene el aula seleccionada
        }
      });
    });

    // Listener para 'Al Mapa' (visible para todos)
    document.getElementById('btn-al-mapa').addEventListener('click', () => {
      window.location.href = 'views/pisos.php';
    });

    // Listener para 'Todas las Aulas' (visible para todos)
    document.getElementById('btn-todas-aulas').addEventListener('click', () => {
      renderVistaGeneral();
    });

    // Listener para 'Cerrar Sesi√≥n'
    document.getElementById('btn-logout').addEventListener('click', () => {
      fetch('acciones/logout.php', { method: 'POST' })
        .then(() => {
          window.location.href = 'login.php';
        })
        .catch(error => {
          console.error('Error en logout:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo cerrar la sesi√≥n. Por favor, intenta de nuevo.',
          });
        });
    });

    // Listener para 'Panel Admin' (visible solo para admins)
    document.getElementById('btn-admin').addEventListener('click', () => {
      console.log('üõ†Ô∏è Accediendo al panel de administraci√≥n');
      // Ejemplo: redirigir a una p√°gina de admin (ajusta seg√∫n tu necesidad)
      // window.location.href = 'admin_panel.php';
    });

    // Mostrar u ocultar botones seg√∫n el rol del usuario
    document.addEventListener('DOMContentLoaded', () => {
      fetch('acciones/check_role.php')
        .then(res => {
          if (!res.ok) {
            throw new Error('Error en la respuesta de check_role.php: ' + res.status);
          }
          return res.json();
        })
        .then(data => {
          console.log('üßë Respuesta de check_role:', data); // Para depuraci√≥n
          const isLoggedIn = data.isLoggedIn;
          const isAdmin = data.isAdmin;

          // Mostrar logout si est√° logueado
          const logoutContainer = document.getElementById('contenedor-logout');
          if (isLoggedIn) {
            logoutContainer.style.display = 'block';
          } else {
            logoutContainer.style.display = 'none';
          }

          // Mostrar bot√≥n admin solo si es administrador
          const adminButton = document.getElementById('btn-admin');
          if (isLoggedIn && isAdmin) {
            adminButton.style.display = 'none';
          } else {
            adminButton.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error al verificar rol:', error);
          // Mantener logout oculto en caso de error
          document.getElementById('contenedor-logout').style.display = 'none';
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo verificar la sesi√≥n. Por favor, recarga la p√°gina.',
          });
        });
    });
  </script>
</body>
</html>